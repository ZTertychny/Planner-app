services:
  db:
    image: postgres:17
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
  planner:
    build:
      context: .
      dockerfile: services/planner-service/Dockerfile
    image: ${DOCKERHUB_USERNAME}/planner-service:${APP_VERSION}
    environment:
      BOT_HOST: ${BOT_HOST}
      NOTIFICATION_PORT: ${NOTIFICATION_PORT}
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/postgres
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      DADATA_TOKEN: ${DADATA_TOKEN}
      DADATA_SECRET: ${DADATA_SECRET}
      TWOGIS_API_KEY: ${TWOGIS_API_KEY}
      LOGSTASH_HOST: ${LOGSTASH_HOST}
      LOGSTASH_PORT: ${LOGSTASH_PORT}
    ports:
      - 8080:8080
    depends_on:
      - db
      - telegram-bot
  telegram-bot:
    build:
      context: .
      dockerfile: services/bot-service/Dockerfile
    image: ${DOCKERHUB_USERNAME}/bot-service:${APP_VERSION}
    environment:
      SERVICE_HOST: ${SERVICE_HOST}
      SERVICE_PORT: ${SERVICE_PORT}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_BOT_USER_NAME: ${TELEGRAM_BOT_USER_NAME}
      LOGSTASH_HOST: ${LOGSTASH_HOST}
      LOGSTASH_PORT: ${LOGSTASH_PORT}
    ports:
      - 8088:8088
    depends_on:
      - db
volumes:
  pgdata: { }